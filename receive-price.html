<script type="text/javascript">
  RED.nodes.registerType("ps-receive-price", {
    category: "Power Saver",
    color: "#a6bbcf",
    defaults: {
      name: { value: "Price Receiver" },
    },
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-eur",
    color: "#FFCC66",
    label: function () {
      return this.name || "ps-receive-price";
    },
  });
</script>

<script type="text/html" data-template-name="ps-receive-price">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" style="width: 240px" />
  </div>
</script>

<script type="text/markdown" data-help-name="ps-receive-price">
  A node to receive price data from one of the supported sources,
  and adapt it for calculation in the Power Saver strategy nodes.

  ### Inputs

  : payload (string) : Price data in one of the supported formats. See details below.

  ### Output

  : payload (string) : Price data transformed to a format that is used by the Power Saver strategy nodes.

  ### Details

  Data received on the input `msg.payload` is transformed to a standard format and sent to
  to output in the `msg.payload` object. The standard format is the one used by the
  Power Saver strategy nodes.

  The following input sources are supported:

  - Tibber
  - Nordpool
  - Other

  #### Tibber input

  If you are a Tibber customer, you can use the `tibber-query` node from
  [`node-red-contrib-tibber-api`](https://flows.nodered.org/node/node-red-contrib-tibber-api).
  Set it up with the following query:

  ```gql
  {
    viewer {
      homes {
        currentSubscription {
          priceInfo {
            today {
              total
              startsAt
            }
            tomorrow {
              total
              startsAt
            }
          }
        }
      }
    }
  }
  ```

  Send the result from the `tibber-query` node with the query above to this node.
  Make sure it is refreshed when new prices are ready.
  Prices for the next day are normally ready at 13:00, but refreshing every hour can be a good idea.

  [See example with Tibber, a switch and MQTT](doc/example-tibber-mqtt.md)

  #### Nordpool input

  This is especially designed to work for Home Assistant (HA),
  and the [Nordpool custom component](https://github.com/custom-components/nordpool).
  The Nordpool component provides a _sensor_ that gives price per hour for today and tomorrow (after 13:00).
  Send the output from this sensor directly to the `ps-receive-price` node.
  Make sure this is done whenever the node is updated, as well as when the system starts up.

  Data can be sent from both the `current state` node or the `events: state` node.

  [See example with Nordpool and `current state` node](doc/example-nordpool-current-state.md)

  [See example with Nordpool and `events: state` node](doc/example-nordpool-events-state.md)

  #### Other input

  If you cannot use any of the two above (Tibber or Nordpool),
  create the input to the node with the payload containing JSON like this:

  ```json
  {
    "today": [
      { "value": 1, "start": "2021-06-21T00:00:00+02:00" },
      { "value": 2, "start": "2021-06-21T01:00:00+02:00" }
      //...
    ],
    "tomorrow": [
      { "value": 3, "start": "2021-06-22T00:00:00+02:00" },
      { "value": 4, "start": "2021-06-22T01:00:00+02:00" }
      //...
    ]
  }
  ```

  #### Output

  The output is a Javascript array of price/time objects.
  Example:

  ```js
  [
    { value: 1, start: "2021-06-21T00:00:00+02:00" },
    { value: 2, start: "2021-06-21T01:00:00+02:00" },
    { value: 3, start: "2021-06-21T02:00:00+02:00" },
    { value: 4, start: "2021-06-21T03:00:00+02:00" },
    //...
  ];
  ```

  The input often contains data for today and tomorrow in two different arrays.
  These are merged to one array in this node.
  The array, that of course is an object, since it is Javascript,
  also has an attribute `source` that contains the name of the source, either
  `Tibber`, `Nordpool` or `Other`.

  ### References

  [Documentation](https://github.com/ottopaulsen/node-red-contrib-power-saver)
</script>
