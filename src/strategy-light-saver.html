<script type="text/javascript">
  RED.nodes.registerType("ps-strategy-light-saver", {
    category: "Power Saver",
    color: "#FFCC66",
    defaults: {
      name: { value: "Light Saver" },
      server: { value: "", type: "server", required: true },
      triggers: { value: [] },
      lights: { value: [] },
      levels: { value: [{ fromTime: "00:00", level: 100 }] },
    },
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-lightbulb-o",
    label: function () {
      return this.name || "Light Saver";
    },
    outputLabels: ["state change"],
    oneditprepare: function () {
      const node = this;
      const $server = $("#node-input-server");
      const $triggersContainer = $("#triggers-container");
      const $lightsContainer = $("#lights-container");
      const $levelsContainer = $("#levels-container");
      
      let availableEntities = [];
      
      // Initialize server selector and get entities
      const updateEntities = function() {
        const serverId = $server.val();
        
        if (!serverId) {
          $triggersContainer.html('<div class="form-tips" style="padding: 10px;">Please select a Home Assistant server first</div>');
          $lightsContainer.html('<div class="form-tips" style="padding: 10px;">Please select a Home Assistant server first</div>');
          return;
        }
        
        $triggersContainer.html('<div class="form-tips" style="padding: 10px;">Loading entities from Home Assistant...</div>');
        $lightsContainer.html('<div class="form-tips" style="padding: 10px;">Loading entities from Home Assistant...</div>');
        
        // Use the working endpoint format
        const endpoint = `homeassistant/entities/${serverId}`;
        
        $.getJSON(endpoint)
          .done(function(entities) {
            if (!entities || entities.length === 0) {
              console.warn('No entities returned from Home Assistant');
              availableEntities = [];
              renderEntityLists();
              return;
            }
            
            // Extract entity IDs
            availableEntities = entities.map(e => e.entity_id || e);
            console.log('Loaded', availableEntities.length, 'entities from Home Assistant');
            renderEntityLists();
          })
          .fail(function(jqxhr, textStatus, error) {
            console.error('Failed to load entities:', textStatus, error);
            RED.notify('Failed to load entities from Home Assistant', 'error');
            availableEntities = [];
            renderEntityLists();
          });
      };
      
      const renderEntityLists = function() {
        renderTriggers();
        renderLights();
        renderLevels();
      };
      
      // Helper to update delete button visibility based on list count
      const updateDeleteButtons = function($list) {
        const count = $list.children().length;
        if (count > 1) {
          $list.find('button[title="Delete Entity"], button[title="Delete Level"]').show();
        } else {
          $list.find('button[title="Delete Entity"], button[title="Delete Level"]').hide();
        }
      };
      
      const renderTriggers = function() {
        let html = `
          <label>
            <i class="fa fa-list"></i> Triggers
          </label>
          <ol id="triggers-list" style="list-style: none; padding: 0; margin: 0;"></ol>
          <button type="button" id="add-trigger-btn" class="editor-button" style="margin-top: 5px;">
            <i class="fa fa-plus"></i> Add Entity
          </button>
        `;
        $triggersContainer.html(html);
        
        const $list = $('#triggers-list');
        
        // Add existing triggers
        if (node.triggers && node.triggers.length > 0) {
          node.triggers.forEach(trigger => {
            addEntityRow($list, trigger.entity_id || '', 'binary_sensor', trigger.timeoutMinutes);
          });
        } else {
          // Add one empty row
          addEntityRow($list, '', 'binary_sensor', '');
        }
        
        // Add button handler
        $('#add-trigger-btn').on('click', function(e) {
          e.preventDefault();
          addEntityRow($list, '', 'binary_sensor', '');
          updateDeleteButtons($list);
        });
        
        updateDeleteButtons($list);
      };
      
      const renderLights = function() {
        let html = `
          <label style="margin-top: 20px;">
            <i class="fa fa-lightbulb-o"></i> Lights
          </label>
          <ol id="lights-list" style="list-style: none; padding: 0; margin: 0;"></ol>
          <button type="button" id="add-light-btn" class="editor-button" style="margin-top: 5px;">
            <i class="fa fa-plus"></i> Add Entity
          </button>
        `;
        $lightsContainer.html(html);
        
        const $list = $('#lights-list');
        
        // Add existing lights
        if (node.lights && node.lights.length > 0) {
          node.lights.forEach(light => {
            addEntityRow($list, light.entity_id || '', 'light,switch', null);
          });
        } else {
          // Add one empty row
          addEntityRow($list, '', 'light,switch', null);
        }
        
        // Add button handler
        $('#add-light-btn').on('click', function(e) {
          e.preventDefault();
          addEntityRow($list, '', 'light,switch', null);
          updateDeleteButtons($list);
        });
        
        updateDeleteButtons($list);
      };
      
      const renderLevels = function() {
        let html = `
          <label style="margin-top: 20px;">
            <i class="fa fa-adjust"></i> Light levels
          </label>
          <ol id="levels-list" style="list-style: none; padding: 0; margin: 0;"></ol>
          <button type="button" id="add-level-btn" class="editor-button" style="margin-top: 5px;">
            <i class="fa fa-plus"></i> Add Level
          </button>
        `;
        $levelsContainer.html(html);
        
        const $list = $('#levels-list');
        
        // Add existing levels
        if (node.levels && node.levels.length > 0) {
          node.levels.forEach(level => {
            addLevelRow($list, level.fromTime || '', level.level !== undefined ? level.level : '');
          });
        } else {
          // Add one default row
          addLevelRow($list, '00:00', 100);
        }
        
        // Add button handler
        $('#add-level-btn').on('click', function(e) {
          e.preventDefault();
          addLevelRow($list, '', '');
          updateDeleteButtons($list);
        });
        
        updateDeleteButtons($list);
      };
      
      const addLevelRow = function($list, fromTime, level) {
        const row = $('<li/>').css({
          padding: '5px',
          border: '1px solid #ccc',
          marginBottom: '5px',
          backgroundColor: '#fff',
          display: 'flex',
          alignItems: 'center',
          gap: '8px'
        });
        
        // From time input
        const fromTimeWrapper = $('<div/>').css({
          display: 'flex',
          alignItems: 'center',
          gap: '5px'
        });
        
        const fromTimeLabel = $('<span/>').text('From time:').css({
          fontSize: '11px',
          whiteSpace: 'nowrap'
        });
        
        const fromTimeInput = $('<input type="text" class="from-time-input" placeholder="HH:MM" maxlength="5"/>').css({
          width: '60px',
          padding: '3px',
          textAlign: 'center',
          fontFamily: 'monospace'
        });
        
        if (fromTime) {
          fromTimeInput.val(fromTime);
        }
        
        // Validate time format HH:MM
        fromTimeInput.on('blur', function() {
          let val = $(this).val().trim();
          if (val === '') return;
          
          // Try to parse time
          const match = val.match(/^(\d{1,2}):?(\d{2})$/);
          if (match) {
            let hours = parseInt(match[1]);
            let minutes = parseInt(match[2]);
            
            if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
              $(this).val(String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0'));
              $(this).css('border-color', '');
              return;
            }
          }
          
          // Invalid format
          $(this).css('border-color', 'red');
          RED.notify('Invalid time format. Use HH:MM (00:00 to 23:59)', 'warning');
        });
        
        fromTimeWrapper.append(fromTimeLabel).append(fromTimeInput);
        
        // Level input
        const levelWrapper = $('<div/>').css({
          display: 'flex',
          alignItems: 'center',
          gap: '5px'
        });
        
        const levelLabel = $('<span/>').text('Level:').css({
          fontSize: '11px',
          whiteSpace: 'nowrap'
        });
        
        const levelInput = $('<input type="number" class="level-input" min="0" max="100" step="1" placeholder=""/>').css({
          width: '50px',
          padding: '3px',
          textAlign: 'right'
        });
        
        if (level !== '') {
          levelInput.val(level);
        }
        
        // Validate level
        levelInput.on('input', function() {
          let val = $(this).val();
          if (val !== '') {
            val = parseInt(val);
            if (isNaN(val) || val < 0) {
              $(this).val('');
            } else if (val > 100) {
              $(this).val(100);
            } else {
              $(this).val(Math.floor(val));
            }
          }
        });
        
        const levelUnit = $('<span/>').text('%').css({
          fontSize: '11px'
        });
        
        levelWrapper.append(levelLabel).append(levelInput).append(levelUnit);
        
        const deleteButton = $('<button type="button" class="editor-button editor-button-small" title="Delete Level"><i class="fa fa-trash"></i></button>');
        
        deleteButton.on('click', function(e) {
          e.preventDefault();
          if ($list.children().length > 1) {
            row.remove();
            updateDeleteButtons($list);
          } else {
            RED.notify('At least one level is required', 'warning');
          }
        });
        
        row.append(fromTimeWrapper).append(levelWrapper).append(deleteButton);
        $list.append(row);
      };
      
      const addEntityRow = function($list, entityId, filterPrefix, timeoutMinutes) {
        const row = $('<li/>').css({
          padding: '5px',
          border: '1px solid #ccc',
          marginBottom: '5px',
          backgroundColor: '#fff',
          display: 'flex',
          alignItems: 'center',
          gap: '5px'
        });
        
        const inputWrapper = $('<div/>').css({
          flex: '1',
          position: 'relative'
        });
        
        // Create search input
        const searchInput = $('<input type="text" placeholder="Search or type entity ID..."/>').css({
          width: '100%',
          padding: '5px',
          boxSizing: 'border-box'
        });
        
        // Create dropdown
        const select = $('<select class="entity-selector" size="8"/>').css({
          width: '100%',
          display: 'none',
          position: 'absolute',
          top: '100%',
          left: '0',
          zIndex: 1000,
          backgroundColor: 'white',
          border: '1px solid #ccc',
          maxHeight: '200px',
          marginTop: '2px'
        });
        
        // Populate dropdown
        const populateSelect = function(filter) {
          select.empty();
          
          if (availableEntities.length === 0) {
            select.append('<option disabled>No entities found - type entity ID manually</option>');
            return;
          }
          
          // Filter entities based on prefix
          let filteredEntities = availableEntities;
          if (filterPrefix) {
            const prefixes = filterPrefix.split(',');
            filteredEntities = availableEntities.filter(e => 
              prefixes.some(prefix => e.startsWith(prefix + '.'))
            );
          }
          
          // Group entities by domain
          const grouped = {};
          let matchCount = 0;
          
          filteredEntities.forEach(entity => {
            if (!filter || entity.toLowerCase().includes(filter.toLowerCase())) {
              const domain = entity.split('.')[0];
              if (!grouped[domain]) grouped[domain] = [];
              grouped[domain].push(entity);
              matchCount++;
            }
          });
          
          if (matchCount === 0) {
            select.append('<option disabled>No matches found</option>');
            return;
          }
          
          Object.keys(grouped).sort().forEach(domain => {
            const optgroup = $(`<optgroup label="${domain.toUpperCase()}"/>`);
            grouped[domain].sort().forEach(entity => {
              optgroup.append($('<option/>').val(entity).text(entity));
            });
            select.append(optgroup);
          });
        };
        
        // Set initial value
        if (entityId) {
          searchInput.val(entityId);
        }
        
        // Show/hide dropdown on focus
        searchInput.on('focus', function() {
          populateSelect($(this).val());
          select.show();
        });
        
        searchInput.on('blur', function() {
          setTimeout(() => select.hide(), 200);
        });
        
        // Filter on input
        searchInput.on('input', function() {
          populateSelect($(this).val());
          select.show();
        });
        
        // Select from dropdown
        select.on('click', 'option', function() {
          const val = $(this).val();
          if (val) {
            searchInput.val(val);
          }
          select.hide();
        });
        
        inputWrapper.append(searchInput).append(select);
        
        // Add timeout input for triggers (null means it's a light)
        let timeoutWrapper = null;
        if (timeoutMinutes !== null) {
          timeoutWrapper = $('<div/>').css({
            display: 'flex',
            alignItems: 'center',
            gap: '3px',
            minWidth: '120px'
          });
          
          const timeoutLabel = $('<span/>').text('Timeout:').css({
            fontSize: '11px',
            whiteSpace: 'nowrap'
          });
          
          const timeoutInput = $('<input type="number" class="timeout-input" min="0" max="999" step="1" placeholder=""/>').css({
            width: '50px',
            padding: '3px',
            textAlign: 'right'
          });
          
          const timeoutUnit = $('<span/>').text('min').css({
            fontSize: '11px'
          });
          
          if (timeoutMinutes !== undefined && timeoutMinutes !== '') {
            timeoutInput.val(timeoutMinutes);
          }
          
          // Validate input
          timeoutInput.on('input', function() {
            let val = $(this).val();
            if (val !== '') {
              val = parseInt(val);
              if (isNaN(val) || val < 0) {
                $(this).val('');
              } else if (val > 999) {
                $(this).val(999);
              } else {
                $(this).val(Math.floor(val));
              }
            }
          });
          
          timeoutWrapper.append(timeoutLabel).append(timeoutInput).append(timeoutUnit);
        }
        
        const deleteButton = $('<button type="button" class="editor-button editor-button-small" title="Delete Entity"><i class="fa fa-trash"></i></button>').on('click', function(e) {
          e.preventDefault();
          row.remove();
          updateDeleteButtons($list);
        });
        
        row.append(inputWrapper);
        if (timeoutWrapper) {
          row.append(timeoutWrapper);
        }
        row.append(deleteButton);
        $list.append(row);
      };
      
      // Initialize on server change
      $server.on("change", updateEntities);
      
      // Initialize on open
      setTimeout(updateEntities, 100);
    },
    oneditsave: function() {
      // Save triggers
      const triggers = [];
      $("#triggers-list li").each(function() {
        const entityId = $(this).find('input[type="text"]').val().trim();
        if (entityId) {
          const trigger = { entity_id: entityId };
          const timeoutVal = $(this).find('.timeout-input').val();
          if (timeoutVal !== '' && timeoutVal !== undefined) {
            trigger.timeoutMinutes = parseInt(timeoutVal);
          }
          triggers.push(trigger);
        }
      });
      this.triggers = triggers;
      
      // Save lights
      const lights = [];
      $("#lights-list li").each(function() {
        const entityId = $(this).find('input[type="text"]').val().trim();
        if (entityId) {
          lights.push({ entity_id: entityId });
        }
      });
      this.lights = lights;
      
      // Save levels
      const levels = [];
      $("#levels-list li").each(function() {
        const fromTime = $(this).find('.from-time-input').val().trim();
        const level = $(this).find('.level-input').val();
        if (fromTime && level !== '') {
          levels.push({ 
            fromTime: fromTime,
            level: parseInt(level)
          });
        }
      });
      this.levels = levels;
    }
  });
</script>

<script type="text/html" data-template-name="ps-strategy-light-saver">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width: 70%">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
        <input type="text" id="node-input-server" style="width: 70%">
    </div>
    <div class="form-row">
        <div id="triggers-container"></div>
    </div>
    <div class="form-row">
        <div id="lights-container"></div>
    </div>
    <div class="form-row">
        <div id="levels-container"></div>
    </div>
</script>

<script type="text/markdown" data-help-name="ps-strategy-light-saver">
  A node to monitor Home Assistant entities and send state changes to the output.

  ### Inputs
  None - This node monitors Home Assistant entities automatically.

  ### Outputs
  1. **State changes**
     - `msg.topic` - The entity ID that triggered the state change
     - `msg.payload` - The new state value
     - `msg.data.entity_id` - The entity ID
     - `msg.data.new_state` - Full new state object with state, attributes, timestamps
     - `msg.data.old_state` - Full old state object (or null if unavailable)
     - `msg.data.timestamp` - ISO timestamp when the state change was processed

  ### Configuration
  - **Server**: Select the Home Assistant server configuration
  - **Triggers**: Select one or more Home Assistant entities to monitor for state changes

  ### Details
  This node connects to Home Assistant via websocket and monitors the selected entities.
  When any entity changes state, it sends the state change information to the output.

  Requires the `node-red-contrib-home-assistant-websocket` package to be installed.

  Please read more in the [node documentation](https://powersaver.no/nodes/ps-strategy-light-saver)
</script>
