const cloneDeep = require("lodash.clonedeep");
const { DateTime } = require("luxon");
const expect = require("chai").expect;
const helper = require("node-red-node-test-helper");
const lowestPrice = require("../src/strategy-lowest-price.js");
const { makeFlow, makePayload } = require("./strategy-lowest-price-test-utils");

helper.init(require.resolve("node-red"));

// Test data with 15-minute intervals from Energidataservice
const testPriceData = {
    "source": "Energidataservice",
    "priceData": [
        {
            "value": 1.947,
            "start": "2025-09-11T00:00:00+02:00"
        },
        {
            "value": 1.947,
            "start": "2025-09-11T00:15:00+02:00"
        },
        {
            "value": 1.947,
            "start": "2025-09-11T00:30:00+02:00"
        },
        {
            "value": 1.947,
            "start": "2025-09-11T00:45:00+02:00"
        },
        {
            "value": 1.916,
            "start": "2025-09-11T01:00:00+02:00"
        },
        {
            "value": 1.916,
            "start": "2025-09-11T01:15:00+02:00"
        },
        {
            "value": 1.916,
            "start": "2025-09-11T01:30:00+02:00"
        },
        {
            "value": 1.916,
            "start": "2025-09-11T01:45:00+02:00"
        },
        {
            "value": 1.844,
            "start": "2025-09-11T02:00:00+02:00"
        },
        {
            "value": 1.844,
            "start": "2025-09-11T02:15:00+02:00"
        },
        {
            "value": 1.844,
            "start": "2025-09-11T02:30:00+02:00"
        },
        {
            "value": 1.844,
            "start": "2025-09-11T02:45:00+02:00"
        },
        {
            "value": 1.786,
            "start": "2025-09-11T03:00:00+02:00"
        },
        {
            "value": 1.786,
            "start": "2025-09-11T03:15:00+02:00"
        },
        {
            "value": 1.786,
            "start": "2025-09-11T03:30:00+02:00"
        },
        {
            "value": 1.786,
            "start": "2025-09-11T03:45:00+02:00"
        },
        {
            "value": 1.785,
            "start": "2025-09-11T04:00:00+02:00"
        },
        {
            "value": 1.785,
            "start": "2025-09-11T04:15:00+02:00"
        },
        {
            "value": 1.785,
            "start": "2025-09-11T04:30:00+02:00"
        },
        {
            "value": 1.785,
            "start": "2025-09-11T04:45:00+02:00"
        },
        {
            "value": 1.798,
            "start": "2025-09-11T05:00:00+02:00"
        },
        {
            "value": 1.798,
            "start": "2025-09-11T05:15:00+02:00"
        },
        {
            "value": 1.798,
            "start": "2025-09-11T05:30:00+02:00"
        },
        {
            "value": 1.798,
            "start": "2025-09-11T05:45:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T06:00:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T06:15:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T06:30:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T06:45:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T07:00:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T07:15:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T07:30:00+02:00"
        },
        {
            "value": 2.032,
            "start": "2025-09-11T07:45:00+02:00"
        },
        {
            "value": 2.043,
            "start": "2025-09-11T08:00:00+02:00"
        },
        {
            "value": 2.043,
            "start": "2025-09-11T08:15:00+02:00"
        },
        {
            "value": 2.043,
            "start": "2025-09-11T08:30:00+02:00"
        },
        {
            "value": 2.043,
            "start": "2025-09-11T08:45:00+02:00"
        },
        {
            "value": 1.825,
            "start": "2025-09-11T09:00:00+02:00"
        },
        {
            "value": 1.825,
            "start": "2025-09-11T09:15:00+02:00"
        },
        {
            "value": 1.825,
            "start": "2025-09-11T09:30:00+02:00"
        },
        {
            "value": 1.825,
            "start": "2025-09-11T09:45:00+02:00"
        },
        {
            "value": 1.615,
            "start": "2025-09-11T10:00:00+02:00"
        },
        {
            "value": 1.615,
            "start": "2025-09-11T10:15:00+02:00"
        },
        {
            "value": 1.615,
            "start": "2025-09-11T10:30:00+02:00"
        },
        {
            "value": 1.615,
            "start": "2025-09-11T10:45:00+02:00"
        },
        {
            "value": 1.308,
            "start": "2025-09-11T11:00:00+02:00"
        },
        {
            "value": 1.308,
            "start": "2025-09-11T11:15:00+02:00"
        },
        {
            "value": 1.308,
            "start": "2025-09-11T11:30:00+02:00"
        },
        {
            "value": 1.308,
            "start": "2025-09-11T11:45:00+02:00"
        },
        {
            "value": 1.269,
            "start": "2025-09-11T12:00:00+02:00"
        },
        {
            "value": 1.269,
            "start": "2025-09-11T12:15:00+02:00"
        },
        {
            "value": 1.269,
            "start": "2025-09-11T12:30:00+02:00"
        },
        {
            "value": 1.269,
            "start": "2025-09-11T12:45:00+02:00"
        },
        {
            "value": 1.259,
            "start": "2025-09-11T13:00:00+02:00"
        },
        {
            "value": 1.259,
            "start": "2025-09-11T13:15:00+02:00"
        },
        {
            "value": 1.259,
            "start": "2025-09-11T13:30:00+02:00"
        },
        {
            "value": 1.259,
            "start": "2025-09-11T13:45:00+02:00"
        },
        {
            "value": 1.271,
            "start": "2025-09-11T14:00:00+02:00"
        },
        {
            "value": 1.271,
            "start": "2025-09-11T14:15:00+02:00"
        },
        {
            "value": 1.271,
            "start": "2025-09-11T14:30:00+02:00"
        },
        {
            "value": 1.271,
            "start": "2025-09-11T14:45:00+02:00"
        },
        {
            "value": 1.258,
            "start": "2025-09-11T15:00:00+02:00"
        },
        {
            "value": 1.258,
            "start": "2025-09-11T15:15:00+02:00"
        },
        {
            "value": 1.258,
            "start": "2025-09-11T15:30:00+02:00"
        },
        {
            "value": 1.258,
            "start": "2025-09-11T15:45:00+02:00"
        },
        {
            "value": 1.315,
            "start": "2025-09-11T16:00:00+02:00"
        },
        {
            "value": 1.315,
            "start": "2025-09-11T16:15:00+02:00"
        },
        {
            "value": 1.315,
            "start": "2025-09-11T16:30:00+02:00"
        },
        {
            "value": 1.315,
            "start": "2025-09-11T16:45:00+02:00"
        },
        {
            "value": 2.126,
            "start": "2025-09-11T17:00:00+02:00"
        },
        {
            "value": 2.126,
            "start": "2025-09-11T17:15:00+02:00"
        },
        {
            "value": 2.126,
            "start": "2025-09-11T17:30:00+02:00"
        },
        {
            "value": 2.126,
            "start": "2025-09-11T17:45:00+02:00"
        },
        {
            "value": 2.486,
            "start": "2025-09-11T18:00:00+02:00"
        },
        {
            "value": 2.486,
            "start": "2025-09-11T18:15:00+02:00"
        },
        {
            "value": 2.486,
            "start": "2025-09-11T18:30:00+02:00"
        },
        {
            "value": 2.486,
            "start": "2025-09-11T18:45:00+02:00"
        },
        {
            "value": 2.685,
            "start": "2025-09-11T19:00:00+02:00"
        },
        {
            "value": 2.685,
            "start": "2025-09-11T19:15:00+02:00"
        },
        {
            "value": 2.685,
            "start": "2025-09-11T19:30:00+02:00"
        },
        {
            "value": 2.685,
            "start": "2025-09-11T19:45:00+02:00"
        },
        {
            "value": 2.639,
            "start": "2025-09-11T20:00:00+02:00"
        },
        {
            "value": 2.639,
            "start": "2025-09-11T20:15:00+02:00"
        },
        {
            "value": 2.639,
            "start": "2025-09-11T20:30:00+02:00"
        },
        {
            "value": 2.639,
            "start": "2025-09-11T20:45:00+02:00"
        },
        {
            "value": 2.194,
            "start": "2025-09-11T21:00:00+02:00"
        },
        {
            "value": 2.194,
            "start": "2025-09-11T21:15:00+02:00"
        },
        {
            "value": 2.194,
            "start": "2025-09-11T21:30:00+02:00"
        },
        {
            "value": 2.194,
            "start": "2025-09-11T21:45:00+02:00"
        },
        {
            "value": 1.989,
            "start": "2025-09-11T22:00:00+02:00"
        },
        {
            "value": 1.989,
            "start": "2025-09-11T22:15:00+02:00"
        },
        {
            "value": 1.989,
            "start": "2025-09-11T22:30:00+02:00"
        },
        {
            "value": 1.989,
            "start": "2025-09-11T22:45:00+02:00"
        },
        {
            "value": 1.827,
            "start": "2025-09-11T23:00:00+02:00"
        },
        {
            "value": 1.827,
            "start": "2025-09-11T23:15:00+02:00"
        },
        {
            "value": 1.827,
            "start": "2025-09-11T23:30:00+02:00"
        },
        {
            "value": 1.827,
            "start": "2025-09-11T23:45:00+02:00"
        },
        {
            "value": 1.347,
            "start": "2025-09-12T00:00:00+02:00"
        },
        {
            "value": 1.347,
            "start": "2025-09-12T00:15:00+02:00"
        },
        {
            "value": 1.347,
            "start": "2025-09-12T00:30:00+02:00"
        },
        {
            "value": 1.347,
            "start": "2025-09-12T00:45:00+02:00"
        },
        {
            "value": 1.345,
            "start": "2025-09-12T01:00:00+02:00"
        },
        {
            "value": 1.345,
            "start": "2025-09-12T01:15:00+02:00"
        },
        {
            "value": 1.345,
            "start": "2025-09-12T01:30:00+02:00"
        },
        {
            "value": 1.345,
            "start": "2025-09-12T01:45:00+02:00"
        },
        {
            "value": 1.319,
            "start": "2025-09-12T02:00:00+02:00"
        },
        {
            "value": 1.319,
            "start": "2025-09-12T02:15:00+02:00"
        },
        {
            "value": 1.319,
            "start": "2025-09-12T02:30:00+02:00"
        },
        {
            "value": 1.319,
            "start": "2025-09-12T02:45:00+02:00"
        },
        {
            "value": 1.281,
            "start": "2025-09-12T03:00:00+02:00"
        },
        {
            "value": 1.281,
            "start": "2025-09-12T03:15:00+02:00"
        },
        {
            "value": 1.281,
            "start": "2025-09-12T03:30:00+02:00"
        },
        {
            "value": 1.281,
            "start": "2025-09-12T03:45:00+02:00"
        },
        {
            "value": 1.3,
            "start": "2025-09-12T04:00:00+02:00"
        },
        {
            "value": 1.3,
            "start": "2025-09-12T04:15:00+02:00"
        },
        {
            "value": 1.3,
            "start": "2025-09-12T04:30:00+02:00"
        },
        {
            "value": 1.3,
            "start": "2025-09-12T04:45:00+02:00"
        },
        {
            "value": 1.299,
            "start": "2025-09-12T05:00:00+02:00"
        },
        {
            "value": 1.299,
            "start": "2025-09-12T05:15:00+02:00"
        },
        {
            "value": 1.299,
            "start": "2025-09-12T05:30:00+02:00"
        },
        {
            "value": 1.299,
            "start": "2025-09-12T05:45:00+02:00"
        },
        {
            "value": 1.512,
            "start": "2025-09-12T06:00:00+02:00"
        },
        {
            "value": 1.512,
            "start": "2025-09-12T06:15:00+02:00"
        },
        {
            "value": 1.512,
            "start": "2025-09-12T06:30:00+02:00"
        },
        {
            "value": 1.512,
            "start": "2025-09-12T06:45:00+02:00"
        },
        {
            "value": 1.791,
            "start": "2025-09-12T07:00:00+02:00"
        },
        {
            "value": 1.791,
            "start": "2025-09-12T07:15:00+02:00"
        },
        {
            "value": 1.791,
            "start": "2025-09-12T07:30:00+02:00"
        },
        {
            "value": 1.791,
            "start": "2025-09-12T07:45:00+02:00"
        },
        {
            "value": 1.895,
            "start": "2025-09-12T08:00:00+02:00"
        },
        {
            "value": 1.895,
            "start": "2025-09-12T08:15:00+02:00"
        },
        {
            "value": 1.895,
            "start": "2025-09-12T08:30:00+02:00"
        },
        {
            "value": 1.895,
            "start": "2025-09-12T08:45:00+02:00"
        },
        {
            "value": 1.646,
            "start": "2025-09-12T09:00:00+02:00"
        },
        {
            "value": 1.646,
            "start": "2025-09-12T09:15:00+02:00"
        },
        {
            "value": 1.646,
            "start": "2025-09-12T09:30:00+02:00"
        },
        {
            "value": 1.646,
            "start": "2025-09-12T09:45:00+02:00"
        },
        {
            "value": 1.253,
            "start": "2025-09-12T10:00:00+02:00"
        },
        {
            "value": 1.253,
            "start": "2025-09-12T10:15:00+02:00"
        },
        {
            "value": 1.253,
            "start": "2025-09-12T10:30:00+02:00"
        },
        {
            "value": 1.253,
            "start": "2025-09-12T10:45:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T11:00:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T11:15:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T11:30:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T11:45:00+02:00"
        },
        {
            "value": 1.214,
            "start": "2025-09-12T12:00:00+02:00"
        },
        {
            "value": 1.214,
            "start": "2025-09-12T12:15:00+02:00"
        },
        {
            "value": 1.214,
            "start": "2025-09-12T12:30:00+02:00"
        },
        {
            "value": 1.214,
            "start": "2025-09-12T12:45:00+02:00"
        },
        {
            "value": 1.193,
            "start": "2025-09-12T13:00:00+02:00"
        },
        {
            "value": 1.193,
            "start": "2025-09-12T13:15:00+02:00"
        },
        {
            "value": 1.193,
            "start": "2025-09-12T13:30:00+02:00"
        },
        {
            "value": 1.193,
            "start": "2025-09-12T13:45:00+02:00"
        },
        {
            "value": 1.213,
            "start": "2025-09-12T14:00:00+02:00"
        },
        {
            "value": 1.213,
            "start": "2025-09-12T14:15:00+02:00"
        },
        {
            "value": 1.213,
            "start": "2025-09-12T14:30:00+02:00"
        },
        {
            "value": 1.213,
            "start": "2025-09-12T14:45:00+02:00"
        },
        {
            "value": 1.222,
            "start": "2025-09-12T15:00:00+02:00"
        },
        {
            "value": 1.222,
            "start": "2025-09-12T15:15:00+02:00"
        },
        {
            "value": 1.222,
            "start": "2025-09-12T15:30:00+02:00"
        },
        {
            "value": 1.222,
            "start": "2025-09-12T15:45:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T16:00:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T16:15:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T16:30:00+02:00"
        },
        {
            "value": 1.231,
            "start": "2025-09-12T16:45:00+02:00"
        },
        {
            "value": 1.973,
            "start": "2025-09-12T17:00:00+02:00"
        },
        {
            "value": 1.973,
            "start": "2025-09-12T17:15:00+02:00"
        },
        {
            "value": 1.973,
            "start": "2025-09-12T17:30:00+02:00"
        },
        {
            "value": 1.973,
            "start": "2025-09-12T17:45:00+02:00"
        },
        {
            "value": 2.339,
            "start": "2025-09-12T18:00:00+02:00"
        },
        {
            "value": 2.339,
            "start": "2025-09-12T18:15:00+02:00"
        },
        {
            "value": 2.339,
            "start": "2025-09-12T18:30:00+02:00"
        },
        {
            "value": 2.339,
            "start": "2025-09-12T18:45:00+02:00"
        },
        {
            "value": 2.611,
            "start": "2025-09-12T19:00:00+02:00"
        },
        {
            "value": 2.611,
            "start": "2025-09-12T19:15:00+02:00"
        },
        {
            "value": 2.611,
            "start": "2025-09-12T19:30:00+02:00"
        },
        {
            "value": 2.611,
            "start": "2025-09-12T19:45:00+02:00"
        },
        {
            "value": 2.646,
            "start": "2025-09-12T20:00:00+02:00"
        },
        {
            "value": 2.646,
            "start": "2025-09-12T20:15:00+02:00"
        },
        {
            "value": 2.646,
            "start": "2025-09-12T20:30:00+02:00"
        },
        {
            "value": 2.646,
            "start": "2025-09-12T20:45:00+02:00"
        },
        {
            "value": 2.192,
            "start": "2025-09-12T21:00:00+02:00"
        },
        {
            "value": 2.192,
            "start": "2025-09-12T21:15:00+02:00"
        },
        {
            "value": 2.192,
            "start": "2025-09-12T21:30:00+02:00"
        },
        {
            "value": 2.192,
            "start": "2025-09-12T21:45:00+02:00"
        },
        {
            "value": 2.066,
            "start": "2025-09-12T22:00:00+02:00"
        },
        {
            "value": 2.066,
            "start": "2025-09-12T22:15:00+02:00"
        },
        {
            "value": 2.066,
            "start": "2025-09-12T22:30:00+02:00"
        },
        {
            "value": 2.066,
            "start": "2025-09-12T22:45:00+02:00"
        },
        {
            "value": 1.905,
            "start": "2025-09-12T23:00:00+02:00"
        },
        {
            "value": 1.905,
            "start": "2025-09-12T23:15:00+02:00"
        },
        {
            "value": 1.905,
            "start": "2025-09-12T23:30:00+02:00"
        },
        {
            "value": 1.905,
            "start": "2025-09-12T23:45:00+02:00"
        }
    ]
};

describe("ps-strategy-lowest-price node with 15-minute intervals", function () {
  beforeEach(function (done) {
    helper.startServer(done);
  });

  afterEach(function (done) {
    helper.unload().then(function () {
      helper.stopServer(done);
    });
  });
  it("should find cheapest periods correctly with 15-minute data", function (done) {
    const flow = makeFlow(1, null, true, "0", "0"); // 1 hour on in entire day
    helper.load(lowestPrice, flow, function () {
      const n1 = helper.getNode("n1");
      const n2 = helper.getNode("n2"); // SCHEDULE output

      n2.on("input", function (msg) {
        try {
          expect(msg.payload.schedule).to.be.an("array");
          expect(msg.payload.schedule.length).to.be.greaterThan(0);
          
          // Check that we have some schedule with ON periods
          const onPeriods = msg.payload.schedule.filter(slot => slot.value === true);
          expect(DateTime.fromISO(onPeriods[0].time).hour).to.be.equals(15);
          expect(DateTime.fromISO(onPeriods[1].time).hour).to.be.equals(13);
          done();
        } catch (err) {
          done(err);
        }
      });

      const testPayload = makePayload(testPriceData, "2025-09-11T09:00:00+02:00");
      n1.receive({ payload: testPayload, _msgid: "5568f6cd100d65b0" });
    });
  });
});
